<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Glowing Triple Pendulum</title>
<style>
  html,body{height:100%;margin:0;background:#000;overflow:hidden}
  canvas{display:block}
  .credit{
    position:fixed; right:8px; bottom:8px;
    color:#ccc; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;
    font-size:12px; opacity:0.5;
    pointer-events:none;
  }
</style>
</head>
<body>
<canvas id="main"></canvas>
<canvas id="trail" style="position:fixed;left:0;top:0;pointer-events:none"></canvas>
<div class="credit">Glowing triple pendulum</div>

<script>
(() => {
  const canvas = document.getElementById('main');
  const trailCanvas = document.getElementById('trail');
  const ctx = canvas.getContext('2d', { alpha: false });
  const tctx = trailCanvas.getContext('2d', { alpha: true });

  const origin = { x: 0, y: 0 };
  const G = 980;
  const dt = 1/60;
  const constraintIterations = 6;
  const stampThreshold = 18;
  const stampSize = 3;

  const segments = [
    { length: 180, mass: 1.0 },
    { length: 150, mass: 1.0 },
    { length: 120, mass: 1.0 },
  ];

  const bobs = [];
  const bobColors = ['#ff4444', '#44ff88', '#4488ff'];

  function resize() {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = window.innerWidth;
    const h = window.innerHeight;
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    trailCanvas.width = canvas.width;
    trailCanvas.height = canvas.height;
    trailCanvas.style.width = canvas.style.width;
    trailCanvas.style.height = canvas.style.height;
    tctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    origin.x = w/2;
    origin.y = Math.min(h * 0.15, 160);
  }
  window.addEventListener('resize', resize);

  function createBob(x, y, m) {
    return { x, y, px: x, py: y, mass: m, radius: 10 };
  }

  function initState() {
    let x = origin.x;
    let y = origin.y;
    let angles = [Math.PI*0.7, Math.PI*0.9, Math.PI*0.55];
    for (let i=0;i<segments.length;i++){
      x += Math.sin(angles[i]) * segments[i].length;
      y += Math.cos(angles[i]) * segments[i].length;
      bobs[i] = createBob(x,y,segments[i].mass);
    }
  }
  function nudgeInitialVelocities(){
    for (let b of bobs){
      b.px = b.x - (Math.random()*2-1);
      b.py = b.y - (Math.random()*2-1);
    }
  }

  function integrate(){
    for (let b of bobs){
      const ax=0, ay=G;
      const nx = b.x + (b.x-b.px) + ax*dt*dt;
      const ny = b.y + (b.y-b.py) + ay*dt*dt;
      b.px = b.x; b.py = b.y;
      b.x = nx; b.y = ny;
    }
  }

  function satisfyConstraint(a,b,L){
    if(!a){
      const dx=b.x-origin.x, dy=b.y-origin.y;
      const dist=Math.hypot(dx,dy)||1e-6;
      const diff=(dist-L)/dist;
      b.x-=dx*diff; b.y-=dy*diff;
      return;
    }
    const dx=b.x-a.x, dy=b.y-a.y;
    const dist=Math.hypot(dx,dy)||1e-6;
    const diff=(dist-L)/dist;
    const invA=1/a.mass, invB=1/b.mass, w=invA+invB;
    const corrA=invA/w, corrB=invB/w;
    a.x+=dx*diff*corrA;
    a.y+=dy*diff*corrA;
    b.x-=dx*diff*corrB;
    b.y-=dy*diff*corrB;
  }

  function drawBackground(){
    ctx.fillStyle="#000";
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  function fadeTrails(){
    tctx.fillStyle="rgba(0,0,0,0.03)";
    tctx.fillRect(0,0,trailCanvas.width,trailCanvas.height);
  }

  function stampIntercept(x,y,color){
    tctx.beginPath();
    tctx.fillStyle=color;
    tctx.arc(x,y,stampSize,0,Math.PI*2);
    tctx.fill();
  }

  function drawRod(x1,y1,x2,y2,color){
    ctx.shadowBlur=12;
    ctx.shadowColor=color;
    ctx.strokeStyle=color;
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(x1,y1);
    ctx.lineTo(x2,y2);
    ctx.stroke();
    ctx.shadowBlur=0;
  }

  function drawBob(b,color){
    // glow halo
    const halo=ctx.createRadialGradient(b.x,b.y,0,b.x,b.y,b.radius*5);
    halo.addColorStop(0,color);
    halo.addColorStop(1,"transparent");
    ctx.fillStyle=halo;
    ctx.beginPath();
    ctx.arc(b.x,b.y,b.radius*5,0,Math.PI*2);
    ctx.fill();

    // main glowing bob
    const grad=ctx.createRadialGradient(b.x,b.y,0,b.x,b.y,b.radius);
    grad.addColorStop(0,"#fff");
    grad.addColorStop(0.4,color);
    grad.addColorStop(1,color);
    ctx.shadowBlur=25;
    ctx.shadowColor=color;
    ctx.fillStyle=grad;
    ctx.beginPath();
    ctx.arc(b.x,b.y,b.radius,0,Math.PI*2);
    ctx.fill();
    ctx.shadowBlur=0;
  }

  function drawScene(){
    drawBackground();
    const p0=origin,p1=bobs[0],p2=bobs[1],p3=bobs[2];
    drawRod(p0.x,p0.y,p1.x,p1.y,bobColors[0]);
    drawRod(p1.x,p1.y,p2.x,p2.y,bobColors[1]);
    drawRod(p2.x,p2.y,p3.x,p3.y,bobColors[2]);
    drawBob(p1,bobColors[0]);
    drawBob(p2,bobColors[1]);
    drawBob(p3,bobColors[2]);
  }

  const pairCooldown=[[0,0,0],[0,0,0],[0,0,0]];
  const stampCooldown=0.07;
  function checkIntercepts(now){
    for(let i=0;i<bobs.length;i++){
      for(let j=i+1;j<bobs.length;j++){
        const a=bobs[i],b=bobs[j];
        if(Math.hypot(a.x-b.x,a.y-b.y)<stampThreshold){
          if(now-pairCooldown[i][j]>stampCooldown){
            pairCooldown[i][j]=now;
            stampIntercept((a.x+b.x)/2,(a.y+b.y)/2,"#fff");
          }
        }
      }
    }
  }

  let lastTime=performance.now()/1000;
  function step(t){
    const now=t/1000;
    const elapsed=now-lastTime;
    lastTime=now;
    let steps=Math.min(4,Math.max(1,Math.floor(elapsed/dt)));
    for(let s=0;s<steps;s++){
      integrate();
      for(let k=0;k<constraintIterations;k++){
        satisfyConstraint(null,bobs[0],segments[0].length);
        satisfyConstraint(bobs[0],bobs[1],segments[1].length);
        satisfyConstraint(bobs[1],bobs[2],segments[2].length);
      }
    }
    fadeTrails();
    drawScene();
    checkIntercepts(now);
    requestAnimationFrame(step);
  }

  function start(){
    resize(); initState(); nudgeInitialVelocities();
    tctx.fillStyle="#000"; tctx.fillRect(0,0,trailCanvas.width,trailCanvas.height);
    lastTime=performance.now()/1000;
    requestAnimationFrame(step);
  }
  start();
})();
</script>
</body>
</html>
